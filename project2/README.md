# 项目2:数据库初体验

## Prerequisite
- 配置mysql环境, 详情请见官网: https://mysql.com/downloads/
- 配置redis环境, 详情请见官网: https://redis.io/

## 概念理解
还记得上一个项目里我们是怎样存储用户信息的吗? 没错, 我们用了一个user.csv文件将客户端提交的用户信息直接写在user.csv中, 既然只需要一个文件就可以搞定, 为什么我们还需要数据库来存放信息呢? 直接将信息写入文件相比于使用"身经百战"的数据库还是过于naive, 其劣势主要在以下几个场景:
- 每次查找某个user数据的时候都只能从头遍历到尾, 效率很低
- 在写入/读取文件时如果遇到了意外错误, 则导致了垃圾数据的堆积, 后续请求无法正常处理
- 并发请求无法处理

此时就要引入大名鼎鼎的数据库了.     

数据库划分为两种, 
- 关系型数据库: 指采用了关系模型来组织数据的数据库。简单来说，关系模式就是二维表格模型。主要代表有: Mysql, PostgreSQL, SQL Server。
- 非关系型数据库: 主要指那些非关系型的、分布式的，且一般不保证ACID的数据存储系统，主要代表有: MongoDB，Redis、CouchDB.
- 二者主要区别: 
  - 事务: 关系型数据库中如果多张表需要同批次被更新，即如果其中一张表跟新失败的话，其他表也不会更新成功。这种场景可以通过事务来控制，可以在所有命令完成之后，再统一提交事务; 在非关系型数据库中没有事务这个概念，每一个数据集都是原子级别的。
  - 数据表与数据集: 关系型是表格型的，存储在数据表的行和列中。彼此关联，容易提取。而非关系型是大块存储在一起。
  - 预定义结构和动态结构: 在关系型中，必须定义好地段和表结构之后，才能够添加数据，例如定义表的主键、索引、外键等。表结构可以在定义之后更新，但是如果有比较大的结构变更，就会变的比较复杂。在非关系型数据库中，数据可以在任何时候任何地方添加。不需要预先定义。

概念一瞬间多了起来, 不过不用担心, 亲身实践之后你一定会对这两种数据库的使用有了很好的了解. 

## 动手实践
### 任务一: 启用数据库
改写project1, 不再使用user.csv来存放用户信息, 而是使用Mysql, 并且功能与project1全部一致. (Hint: 前面提到关系型数据库使用数据表来存放数据, 所以你首先应该创建好database, database中提前创建一张user表, 字段为username和password。做好这些准备工作后只需要了解nodejs是怎么连接到mysql数据库的, 然后修修改改即可✅).

### 任务二: 密码加密
试想一下, 如果在实际开发中直接将用户的密码放在数据库里, 如果数据不慎泄漏, 则黑客可以直接登陆用户的账号, 恶意篡改信息. 为了防范这类事情的发生, 计算机科学家们发明了加密算法, 由于这部分讲起来又需要长篇大论一番, 你不需要知道加密的原理(我们在开发过程中也不涉及深入理解加密算法这一块儿), 只需要知道如何使用即可.     
你要做的是：修改"post用户信息到localhost:80/user"这个接口, 在存放用户密码的时候加密成一串乱码放在数据库中, 同时依然能够通过get接口获取用户名和密码(未加密的). (Hint: 有现成的包, install后即可使用😊)

### 任务三: 登陆保持
为了良好的用户体验和减轻数据库的负担, 许多网站都采用登陆保持机制, 以Matrix为例: 打开浏览器访问: https://vmatrix.org.cn 后需要输入正确的用户名和密码成功登陆. 此时关掉浏览器, 一段时间内再次访问时并不需要再输一遍用户名密码, 而是会自动跳转到上一次登陆的账户页面.     
那么如何实现呢？其原理是: 如果前端使用用户名/密码向服务端请求认证, 并且服务端认证成功, 那么在服务端会返回 Token 给前端。前端可以在每次请求的时候带上 Token 证明自己的合法地位. 你要做的就是新增一个接口来实现这个过程, 也就是:
- 用postman向url: localhost:80/login 发送post请求, 请求体如下:
```
{
  "username": "matrix",
  "password": "xirtam"
}
```
如果认证成功, 则生成一个token返回给前端(hint: 写在返回头部或者返回体中), 状态码为200, 同时这个token还应存放在redis中, 过期时间为2分钟; 在token的有效期内, 任何对于该url的请求都携带这个token(在请求头部), 此时如果token验证通过,返回状态码都为200, 否则返回403, 返回体为
```
{
  "msg": "请重新登录"
}
```